<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>支付模块手册</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<style type="text/css">
html, body { padding:0; margin:0; }
body { font-size:14px; width:1000px; }
body, h1, h2, h3 { font-family:"微软雅黑","Lucida Grande","Lucida Sans Unicode",Calibri,Arial,Helvetica,Sans,FreeSans,Jamrul,Garuda,Kalimati; }
b { color:#0000cc; }

#menu { background:#EAEEF3; width:200px; border-right:1px solid #C6C9CE; float:left; height:100%; position:fixed; top:0; bottom:0; left:0; right:0; }
#menu_title { padding:24px; margin:0; text-align:right; font-size:24px; color:#576780; }
#menu ul, #menu li { list-style:none; margin:0; padding:0; }
#menu li a { border:1px solid #EAEEF3; border-right:none; border-left:none; }
#menu a { font-size:14px; display:block; padding:10px 24px; text-decoration:none; text-align:right; color:#426DC9; }
#menu .current a, #menu li a:hover { background:#BBCEE9; color:#000; border-color:#8FAAD9; }

#content { margin-left:220px; padding-bottom:24px; margin-right:24px; }
#content h3 { font-size:24px; color:#576780; border-bottom:1px solid #eee; padding-bottom:8px; margin-top:24px; }
#content ul, #content li { margin:0; padding:0; list-style:none; color:#ccc; }
#content li span { color:#000; }
#content li { line-height:24px; list-style-type:disc; margin-left:30px; }
#content p { line-height:24px; }
#content .subp { margin-left:30px; }

#footer { text-align:center; font-size:12px; color:#888; border-top:solid 1px #eee; padding-top:10px; margin-top:24px; }
</style>
<script type="text/javascript">
	var currentItem = 'i1';
</script>
</head>
<body>
<div id="menu">
	<h3 id="menu_title">目录</h3>
	<ul>
		<li onclick="document.getElementById(currentItem).className = ''; currentItem = this.id; this.className = 'current';" class="current" id="i1"><a href="#a">充值支付相关的概念</a></li>
		<li onclick="document.getElementById(currentItem).className = ''; currentItem = this.id; this.className = 'current';" id="i2"><a href="#b">支付管理-支付配置</a></li>
		<li onclick="document.getElementById(currentItem).className = ''; currentItem = this.id; this.className = 'current';" id="i3"><a href="#c">支付管理-管理包月</a></li>
		<li onclick="document.getElementById(currentItem).className = ''; currentItem = this.id; this.className = 'current';" id="i4"><a href="#d">支付管理-管理支付方式</a></li>
		<li onclick="document.getElementById(currentItem).className = ''; currentItem = this.id; this.className = 'current';" id="i5"><a href="#e">支付管理-账号充值统计</a></li>
		<li onclick="document.getElementById(currentItem).className = ''; currentItem = this.id; this.className = 'current';" id="i6"><a href="#f">支付报表-充值记录</a></li>
		<li onclick="document.getElementById(currentItem).className = ''; currentItem = this.id; this.className = 'current';" id="i7"><a href="#g">支付报表-异常充值</a></li>
		<li onclick="document.getElementById(currentItem).className = ''; currentItem = this.id; this.className = 'current';" id="i8"><a href="#h">支付报表-支付记录</a></li>
	</ul>
</div>
<div id="content">
	<h3 id="a">充值支付相关的概念</h3>
	<p>充值和支付是平台的一个重要组成部分，基本功能是：允许用户在平台上通过第三方充值平台（如支付宝等）向平台充入人民币（在平台上对应游戏币，这里暂时定义为知金币，知金币等价于人民币，1块知金币=1元人民币），允许用户以向游戏支付知金币的方式在平台上进行消费。</p>
	
	<p>在平台中，充值和支付是两个完全不同的概念：</p>
	<p class="subp">
		<b>充值</b> ： 充值是一个平台内知金币增加的行为。可以是通过第三方充值平台（如支付宝）直接向平台充值实现平台知金币的增加；也可以是后台管理员在后台直接给用户充入知金币；或者是通过活动，如充值100元，赠送50元的方式。<br>
		<b>支付</b> ： 支付操作则是知金币消费掉的一个过程，只有通过向游戏支付知金币这一种方式来消费知金币，如，向游戏诺瓦奇兵支付100块知金币，则意味着平台上的知金币总数减少了100块。<br>
		<b>知金币充值</b> ： 通过第三方充值平台，向平台充入知金币。<br>
		<b>游戏包月</b> ： 山寨的淘米网上的一个功能(参考：<a href="http://pay.61.com/service" target="_blank">淘米游戏包月</a>)，是一个消费知金币的过程，暂时不会使用。<br>
		<b>知金币兑换</b> ： 直接向游戏支付知金币，也是一个消费知金币的过程。<br>
		<b>费率</b> ： 有些第三方充值平台在完成一笔充值交易后，会抽取一定百分比的金额作为中介费，平台将中介费记到用户身上。如：假定支付宝的费率是30%，用户aaaaaa使用支付宝向平台充入了100元（本来应该得到100块知金币），这时支付宝会抽取30元作为中介费，此时用户从平台得到70块知金币。<br>
	</p>

	<h3 id="b">支付管理-支付配置</h3>
	<p>充值和支付模块的全局配置信息</p>
	<p class="subp">
		<b>是否开启支付模块</b> ： 是否开启充值支付模块，值为yes时开启，否则不开启<br>
		<b>跳转地址</b> ： 设置关闭充值支付模块时的跳转地址，为空时，跳转至游戏首页<br>
		<b>是否开启包月服务</b> ： 是否开启购买包月服务功能，值为yes时开启，否则不开启<br>
		<b>是否开启游戏支付</b> ： 是否开启向游戏直接充值支付功能，值为yes时开启，否则不开启
	</p>

	<h3 id="c">支付管理-管理包月</h3>
	<p>初步山寨的61淘米网上的游戏包月功能，实现在后台管理游戏包月信息，可以增删改游戏包月信息。这个功能仅仅初步实现，如果启用的话，应该要做相当大的调整，暂时保留以备后用。</p>
	
	<h3 id="d">支付管理-管理充值方式</h3>
	<p>管理第三方充值平台信息，需要注意的有：</p>
	<ul>
	    <li><span><b>增加充值方式</b> － 增加支付方式需要程序员配合实现，因为要为新的充值方式开发接口文件。</span></li>
		<li><span><b>充值方式代码</b> － 每个充值方式对应一个唯一的代码，每个代码对应一个接口文件，已经设定，不能修改，如支付宝的代码为alipay，意味着有一个alipay.php接口文件来实现平台与支付宝平台的交互。</span></li>
		<li><span><b>费率</b> － 充值方式抽取的中介费比率，如 0.4，意味着一笔100元的交易，第三方平台要抽取40元中介费</span></li>
		<li><span><b>充值方式状态</b> － 前端用户只能从状态为“开启”的充值方式中选择要使用的充值方式</span></li>
	</ul>
	
	<h3 id="e">支付管理-账号充值统计</h3>
	<p>pay应用为平台上每个发起过充值或支付操作的用户维护一条记录，用来记录该用户充值和支付信息，如下图所示：</p>
	<p><img src="images/pay_user.jpg" /></p>
	<p>表中每一列的含义分别是：</p>
	<p class="subp">
		<b>用户名（用户ID）</b> ： 发起充值或支付操作的用户，每个用户对应一条记录<br>
		<b>余额</b> ： 用户当前可用的知金币数量<br>
		<b>充值金额和充值次数</b> ： 用户意向充值的总金额数和意向充值总次数，如，用户aaaaaa在平台上发起一个充值1000元的请求，平台会把1000元累计到用户“充值金额”，同时充值次数加1，然后引导用户进入第三方充值平台。<br>
		<b>有效充值金额和有效充值次数</b> ： 用户有效充值金额的总金额数和有效充值的总次数。有效指的是我们的银行账号在第三方充值平台上真实接收到了用户充入的金额。如，用户aaaaaa在平台上发起一个充值1000元的请求，平台会把1000元累计到用户“充值金额”，同时充值次数加1，然后引导用户进入第三方充值平台。如果第三方平台返回信息说用户成功充值了100元，平台会为用户的有效充值金额增加100元（假设没有费率），同时用户余额增加100，有效充值次数加1<br>
		<b>最后充值时间</b> ： 最后一次充值的时间<br>
		<b>支付金额和支付次数</b> ： 用户向游戏支付知金币的总数量，用户向游戏支付知金币的总次数<br>
		<b>最后支付时间</b> ： 最后一次支付知金币的时间<br>
		<b>异常金额</b> ： 每个用户应该维护这样一个等量关系：<b>有效充值金额 - （ 余额 + 支付金额） = 0 </b> 等结果不为零时，意味着这个用户的充值或支付发生了异常，应该立刻找程序排查问题。<br>
	</p>
		
	<h3 id="f">支付报表-充值记录</h3>
	<p>pay应用为平台上每个充值操作维护一条充值订单信息，如下图所示：</p>
	<p><img src="images/pay_account.jpg" /></p>
	<p>表中每一列的含义分别是：</p>
	<p class="subp">
		<b>订单ID</b> ： MySQL为订单生成的唯一序列号<br>
		<b>订单号</b> ： 用来唯一标识一条订单的序列号<br>
		<b>充值方式代码</b> ： 这条订单用户选用的第三方充值平台名称<br>
		<b>游戏代码</b> ： 充值操作时，如果指定了同时将充入平台的知金币支付到某一游戏时，这里记录充值时指定的游戏代码（这里显示游戏名称）<br>
		<b>服务器ID</b> ： 充值操作时，如果指定了同时将充入平台的知金币支付到某一游戏的某一游戏服务器时，这里记录充值时指定的服务器ID（这里显示服务器名称）<br>
		<b>包月服务ID</b> ： 充值操作时，如果指定了购买某一游戏包月，这里记录充值时指定的包月服务ID（这里显示包月的名称）<br>
		<b>充值用户</b> ： 执行充值操作时的登陆用户名，仅仅记录当时的登陆用户，如图中ID为4的记录意味着，用户aaaaaa（6个a）登陆到了平台，他执行了一个向用aaaaaaa（7个a）充值333元的操作，成功充值后，用户aaaaaaa（7个a）得到了233.1个知金币（扣除费率后）<br>
		<b>目标用户名</b> ： 本次充值金额要加入到哪个用户的账号余额中<br>
		<b>手机号</b> ： 暂时没有使用，保留备用<br>
		<b>充值金额</b> ： 用户执行充值操作时，意向充值金额<br />
		<b>充值费率</b> ： 充值时，第三方充值平台的费率 <br />
		<b>有效充值金额</b> ： 第三方平台认定充值的金额数（扣除费率后的值） <br />
		<b>充值时间</b> ： 充值操作发起的时间 <br />
		<b>手工充值管理员</b> ： 保留备用 <br />
		<b>充值状态</b> ： 只用两种：未充值和成功充值，未充值指的是仅在平台上发起了充值操作请求，尚未经第三方充值平台通过；成功充值指的是经过第三方充值平台认定充值有效后的充值操作<br />
		<b>管理操作</b> ： 保留备用 <br />
	</p>
		
	<h3 id="g">支付报表-异常充值</h3>
	<p>当平台接收到第三方充值平台返回的充值操作结果的请求时，如果经验证该请求有异常时，会记录一条异常充值记录，异常充值记录的列跟充值记录相同，只有充值状态的值有所不同，异常充值的状态有三种：</p>
	<p class="subp">
		<b>验证失败</b> ： 第三方充值平台发起的充值结果请求，经平台验证失败的充值记录<br>
		<b>未知订单</b> ： 平台上不存在第三方充值平台发起的充值结果请求中指定的订单号<br>
		<b>重复订单</b> ： 平台已处理过第三方充值平台发起的充值结果请求中指定的订单号<br>
	</p>
				
			
	<h3 id="h">支付报表-支付记录</h3>
	<p>pay应用为平台上每个支付操作维护一条支付订单信息，如下图所示：</p>
	<p><img src="images/pay_pay.jpg" /></p>
	<p>表中每一列的含义分别是：</p>
	<p class="subp">
		<b>支付ID</b> ： MySQL为支付订单生成的唯一序列号<br>
		<b>订单号</b> ： 用来唯一标识一条支付订单的序列号<br>
		<b>充值订单号</b> ： 针对那种充值和支付同时进行的情况下，充值订单的订单号。<br>
		<b>游戏代码</b> ： 支付操作时指定的要支付到哪个游戏中，这里显示游戏名称<br>
		<b>服务器ID</b> ： 支付操作时指定的要支付到哪个游戏指定服务器中，这里显示服务器名称<br>
		<b>目标用户名</b> ： 指定哪个用户将在游戏里得到游戏币<br>
		<b>支付用户名</b> ： 花费知金币的用户名，如用户aaaaaa为用户bbbbbb在诺瓦奇兵上支付了100块知金币，则支付记录的“目标用户名”是bbbbbb，“支付用户名”是aaaaaa<br>
		<b>支付金额</b> ： 本次支付花费的知金币数量<br>
		<b>支付时间</b> ： 支付操作发起的时间<br>
	</p>

	<div id="footer"> 最后修改时间：2013-10-12</div>
</div>


</body></html>